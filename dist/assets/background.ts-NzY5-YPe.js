browser.runtime.onMessage.addListener((t,a,r)=>t.action==="authenticate"?(p(t.credentials).then(e=>r({success:!0,data:e})).catch(e=>r({success:!1,error:e.message})),!0):t.action==="getStoredCredentials"?(browser.storage.local.get(["appKey","secretKey","authUrl","gatewayUrl","accessToken","refreshToken","tokenExpiry","selectedPlantId"]).then(e=>r({success:!0,data:e})).catch(e=>r({success:!1,error:e.message})),!0):t.action==="storeCredentials"?(browser.storage.local.set(t.credentials).then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0):t.action==="getPlantList"?(y().then(e=>r({success:!0,data:e})).catch(e=>r({success:!1,error:e.message})),!0):t.action==="getDeviceList"?(f(t.ps_id).then(e=>r({success:!0,data:e})).catch(e=>r({success:!1,error:e.message})),!0):t.action==="getDevicePointData"?(g(t.device_type,t.ps_key,t.point_ids).then(e=>r({success:!0,data:e})).catch(e=>r({success:!1,error:e.message})),!0):(t.action==="refreshToken"&&w().then(e=>r({success:!0,data:e})).catch(e=>r({success:!1,error:e.message})),!0));async function p(t){const{appKey:a,secretKey:r,authUrl:e,gatewayUrl:o}=t;if(!a||!r||!e)throw new Error("App Key, Secret Key, and Authorization URL are required");const n=o||"https://augateway.isolarcloud.com";let i;try{const[s,h]=e.split("?"),l=new URLSearchParams(h),u=browser.identity.getRedirectURL();console.log("Redirect URL:",u),l.set("redirectUrl",u),i=new URL(`${s}?${l.toString()}`)}catch(s){throw new Error("Invalid Authorization URL format: "+s.message)}try{const s=await browser.identity.launchWebAuthFlow({interactive:!0,url:i.toString()});if(!s)throw new Error("Authentication flow was cancelled or failed");const l=new URLSearchParams(new URL(s).search).get("code");if(!l)throw new Error("Authorization code not found in redirect URL");const u=`${n}/openapi/apiManage/token`,d={appkey:a,grant_type:"authorization_code",code:l,redirect_uri:browser.identity.getRedirectURL()},c=await(await fetch(u,{method:"POST",headers:{"Content-Type":"application/json","x-access-key":r},body:JSON.stringify(d)})).json();if(console.log("Authentication data received:",c),c.result_code!=="1")throw new Error(c.result_msg||"Authentication failed during token exchange");return await browser.storage.local.set({accessToken:c.result_data.access_token,refreshToken:c.result_data.refresh_token,tokenExpiry:Date.now()+c.result_data.expires_in*1e3,appKey:a,secretKey:r,authUrl:e,gatewayUrl:n}),browser.alarms.create("tokenRefresh",{delayInMinutes:(c.result_data.expires_in-60)/60}),{authenticated:!0,tokenExpiry:Date.now()+c.result_data.expires_in*1e3}}catch(s){throw console.error("Sungrow authentication error:",s),new Error("Authentication failed: "+(s.message||String(s)))}}browser.alarms.onAlarm.addListener(t=>{t.name==="tokenRefresh"&&w()});async function w(){try{const t=await browser.storage.local.get(["refreshToken","appKey","secretKey","gatewayUrl"]);if(!t.refreshToken)throw console.log("No refresh token available"),new Error("No refresh token available");const a=t.gatewayUrl||"https://augateway.isolarcloud.com",r={refresh_token:t.refreshToken,appkey:t.appKey},e=await fetch(`${a}/openapi/apiManage/refreshToken`,{method:"POST",headers:{"Content-Type":"application/json","x-access-key":t.secretKey},body:JSON.stringify(r)});if(e.ok){const o=await e.json();if(o.result_code!=="1")throw new Error(o.result_msg||"Token refresh API error");return await browser.storage.local.set({accessToken:o.result_data.access_token,refreshToken:o.result_data.refresh_token,tokenExpiry:Date.now()+o.result_data.expires_in*1e3}),browser.alarms.create("tokenRefresh",{delayInMinutes:(o.result_data.expires_in-60)/60}),{success:!0,tokenExpiry:Date.now()+o.result_data.expires_in*1e3}}else throw new Error("Token refresh request failed")}catch(t){throw console.error("Token refresh failed:",t),t}}async function y(){try{const t=await browser.storage.local.get(["appKey","secretKey","gatewayUrl","accessToken"]);if(!t.appKey||!t.secretKey)throw new Error("Missing credentials");const a=t.gatewayUrl||"https://augateway.isolarcloud.com",r={appkey:t.appKey,page:1,size:10},e=await fetch(`${a}/openapi/platform/queryPowerStationList`,{method:"POST",headers:{"Content-Type":"application/json","x-access-key":t.secretKey,Authorization:`Bearer ${t.accessToken}`},body:JSON.stringify(r)});if(e.ok){const o=await e.json();if(o.result_code!=="1")throw new Error(o.result_msg||"Failed to fetch plant list");return o.result_data.pageList}else throw new Error("Network response was not ok")}catch(t){throw console.error("Fetch plant list failed:",t),t}}async function f(t){try{const a=await browser.storage.local.get(["appKey","secretKey","gatewayUrl","accessToken"]);if(!a.appKey||!a.secretKey)throw new Error("Missing credentials");const r=a.gatewayUrl||"https://augateway.isolarcloud.com",e={appkey:a.appKey,ps_id:String(t),page:1,size:50},o=await fetch(`${r}/openapi/platform/getDeviceListByPsId`,{method:"POST",headers:{"Content-Type":"application/json","x-access-key":a.secretKey,Authorization:`Bearer ${a.accessToken}`},body:JSON.stringify(e)});if(o.ok){const n=await o.json();if(n.result_code!=="1")throw new Error(n.result_msg||"Failed to fetch device list");return n.result_data.pageList}else throw new Error("Network response was not ok")}catch(a){throw console.error("Fetch device list failed:",a),a}}async function g(t,a,r){try{const e=await browser.storage.local.get(["appKey","secretKey","gatewayUrl","accessToken"]);if(!e.appKey||!e.secretKey)throw new Error("Missing credentials");const o=e.gatewayUrl||"https://augateway.isolarcloud.com",n={appkey:e.appKey,device_type:t,ps_key_list:[a],point_id_list:r.map(String),is_get_point_dict:"1"},i=await fetch(`${o}/openapi/platform/getDeviceRealTimeData`,{method:"POST",headers:{"Content-Type":"application/json","x-access-key":e.secretKey,Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify(n)});if(i.ok){const s=await i.json();if(s.result_code!=="1")throw new Error(s.result_msg||"Failed to fetch device point data");return s.result_data.device_point_list.map(h=>h.device_point)}else throw new Error("Network response was not ok")}catch(e){throw console.error("Fetch device point data failed:",e),e}}
